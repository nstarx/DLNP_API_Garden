<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Mermaid Diagrams</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    .diagram-wrapper { transition: transform 0.2s ease; transform-origin: 0 0; }
    .diagram-container { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1rem; }
    .dark .diagram-container { background: #1f2937; }
    .btn { padding: 0.5rem 0.75rem; border-radius: 0.375rem; background: #e5e7eb; color: #111827; }
    .btn:hover { background: #d1d5db; }
    .dark .btn { background: #374151; color: #f3f4f6; }
    .dark .btn:hover { background: #4b5563; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
  <header class="bg-white dark:bg-gray-800 shadow sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-diagram-project text-2xl text-blue-600"></i>
        <h1 class="text-xl font-bold text-gray-900 dark:text-white">All Mermaid Diagrams</h1>
      </div>
      <div class="flex items-center gap-2">
        <a href="./index.html" class="btn" title="Back to Docs"><i class="fa-solid fa-book-open"></i></a>
        <button id="themeToggle" class="btn" title="Toggle theme"><i class="fa-solid fa-moon"></i></button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6">
    <section class="w-full">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-3 mb-4 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button class="btn" title="Open in index.html" onclick="window.location.href='index.html'"><i class="fa-solid fa-book-open"></i></button>
          <span class="text-gray-700 dark:text-gray-300 ml-2">Diagrams are now integrated into index.html. Use the header diagrams icon there.</span>
        </div>
      </div>
      <div class="text-gray-700 dark:text-gray-300">This standalone page is deprecated.</div>
    </section>
  </main>

  <script>
    const API_FILES = [
      'design/admin-rest-api-design.md',
      'design/agentic-rest-api-design.md',
      'design/ai-system-rest-api-design.md',
      'design/ai-catalog-rest-api-design.md',
      'design/assets-platform-rest-api-design.md',
      'design/cicd-platform-rest-api-design.md',
      'design/composables-ai-catalog-rest-api-design.md',
      'design/connections-platform-rest-api-design.md',
      'design/data-platform-rest-api-design.md',
      'design/deployments-platform-rest-api-design.md',
      'design/federation-fl-platform-rest-api-design.md',
      'design/rag-platform-rest-api-design.md',
      'design/spark-services-platform-rest-api-design.md',
      'design/views-ui-platform-rest-api-design.md',
      'design/api-statistics-report.md'
    ];

    let diagrams = []; // { id, sourceFile, code, element }
    let currentIndex = 0;
    let zoom = 1;

    document.addEventListener('DOMContentLoaded', init);

    function init() {
      initTheme();
      setupControls();
      loadAllMermaidBlocks();
    }

    function initTheme() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.classList.toggle('dark', theme === 'dark');
      updateThemeIcon(theme);
      document.getElementById('themeToggle').addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        const t = isDark ? 'dark' : 'light';
        localStorage.setItem('theme', t);
        updateThemeIcon(t);
      });
    }
    function updateThemeIcon(theme) {
      const i = document.querySelector('#themeToggle i');
      i.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
    }


    async function loadAllMermaidBlocks() {
      const available = [];
      for (const file of API_FILES) {
        try {
          const head = await fetch(file, { method: 'HEAD' });
          if (head.ok) available.push(file);
        } catch {}
      }

      const found = [];
      for (const file of available) {
        try {
          const res = await fetch(file);
          if (!res.ok) continue;
          const text = await res.text();
          const blocks = extractMermaidBlocks(text);
          blocks.forEach((code, idx) => {
            found.push({ sourceFile: file, code, idx });
          });
        } catch {}
      }

      if (found.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('counter').textContent = '0 / 0';
        return;
      }

      mermaid.initialize({ startOnLoad: false });
      const gallery = document.getElementById('gallery');
      gallery.innerHTML = '';
      diagrams = [];

      for (let i = 0; i < found.length; i++) {
        const item = found[i];
        const container = document.createElement('div');
        container.className = 'diagram-container';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between mb-2';
        header.innerHTML = `
          <div class="text-sm text-gray-600 dark:text-gray-300"><i class="fa-solid fa-file"></i>
            <span class="ml-1">${item.sourceFile} #${item.idx + 1}</span>
          </div>
          <div class="flex gap-2">
            <a class="btn" target="_blank" href="${item.sourceFile}"><i class="fa-solid fa-link"></i></a>
            <button class="btn copyBtn" title="Copy code"><i class="fa-solid fa-copy"></i></button>
          </div>`;

        const wrapper = document.createElement('div');
        wrapper.className = 'diagram-wrapper overflow-auto';
        wrapper.style.transform = `scale(${zoom})`;

        const merDiv = document.createElement('div');
        merDiv.className = 'mermaid';
        merDiv.textContent = item.code;
        wrapper.appendChild(merDiv);

        container.appendChild(header);
        container.appendChild(wrapper);
        gallery.appendChild(container);

        diagrams.push({ id: i, sourceFile: item.sourceFile, code: item.code, element: container });
      }

      await new Promise(r => setTimeout(r, 0));
      mermaid.init(undefined, document.querySelectorAll('#gallery .mermaid'));

      currentIndex = 0;
      updateCounter();
      updateFocus();

      // Hook copy buttons
      document.querySelectorAll('.copyBtn').forEach((btn, idx) => {
        btn.addEventListener('click', () => copyToClipboard(found[idx].code));
      });
    }


    function extractMermaidBlocks(md) {
      // Match fenced code blocks ```mermaid ... ``` including possible ```\nmermaid\n...
      const blocks = [];
      const fenceRegex = /```\s*mermaid\s*\n([\s\S]*?)```/gim;
      let m;
      while ((m = fenceRegex.exec(md)) !== null) {
        blocks.push(m[1].trim());
      }
      return blocks;
    }

    function setupControls() {
      document.getElementById('prevBtn').addEventListener('click', () => navigate(-1));
      document.getElementById('nextBtn').addEventListener('click', () => navigate(1));
      document.getElementById('zoomInBtn').addEventListener('click', () => changeZoom(0.1));
      document.getElementById('zoomOutBtn').addEventListener('click', () => changeZoom(-0.1));
      document.getElementById('zoomResetBtn').addEventListener('click', () => setZoom(1));
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') navigate(-1);
        if (e.key === 'ArrowRight') navigate(1);
        if ((e.ctrlKey || e.metaKey) && e.key === '+') { e.preventDefault(); changeZoom(0.1); }
        if ((e.ctrlKey || e.metaKey) && e.key === '-') { e.preventDefault(); changeZoom(-0.1); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === '0') { e.preventDefault(); setZoom(1); }
      });
    }

    function navigate(delta) {
      if (diagrams.length === 0) return;
      currentIndex = (currentIndex + delta + diagrams.length) % diagrams.length;
      updateCounter();
      updateFocus();
    }

    function updateCounter() {
      const c = document.getElementById('counter');
      c.textContent = `${diagrams.length ? currentIndex + 1 : 0} / ${diagrams.length}`;
    }

    function updateFocus() {
      diagrams.forEach((d, idx) => {
        d.element.classList.toggle('ring-2', idx === currentIndex);
        d.element.classList.toggle('ring-blue-500', idx === currentIndex);
        if (idx === currentIndex) d.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }

    function changeZoom(delta) { setZoom(Math.min(3, Math.max(0.3, zoom + delta))); }
    function setZoom(value) {
      zoom = value;
      document.querySelectorAll('#gallery .diagram-wrapper').forEach(w => { w.style.transform = `scale(${zoom})`; });
    }

    async function copyToClipboard(text) {
      try { await navigator.clipboard.writeText(text); } catch {}
    }
  </script>
</body>
</html>
